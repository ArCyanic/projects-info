<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width initial-scale=1.0">
    <title>优化仪表盘</title>
    <!-- GLOBAL MAINLY STYLES-->
    <link href="./Material/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="./Material/vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="./Material/vendors/themify-icons/css/themify-icons.css" rel="stylesheet" />
    <!-- PLUGINS STYLES-->
    <link href="./Material/vendors/jvectormap/jquery-jvectormap-2.0.3.css" rel="stylesheet" />
    <!-- THEME STYLES-->
    <link href="./Material/css/main.min.css" rel="stylesheet" />
    <!-- PAGE LEVEL STYLES-->


    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.3.0/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.1.2/echarts.min.js"></script>
</head>

<body>
    <div class="page-wrapper">
        <div class="content-wrapper" style="margin-left: 0;">
            <div class="page-content fade-in-up">
                <!-- 一行 -->
                <div class="row">
                    <!-- 地图部分（左边） -->
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">中国地图</div>
                                <div id='sliderbar'>
                                    <strong>Day: <label id='active-day'>1</label></strong>
                                    <input id='slider' class='row' type='range' min='1' max='31' step='1' value='1'
                                        onchange="slider_change()" />
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="map" style="height: 300px;"></div>

                            </div>
                        </div>
                    </div>
                    <!-- 右边 -->
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">主要污染物雷达图</div>
                                <div>
                                    <a class="btn btn-info btn-sm" href="javascript:;">按钮样式</a>
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="radar" style="height: 300px;"></div>

                            </div>
                        </div>
                    </div>
                </div>


                <!-- 一行 -->
                <div class="row">
                    <!-- col-lg-4 中的4 大概可以代表宽度 -->
                    <div class="col-lg-3">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">污染仪表盘</div>
                                <div>
                                    <a class="btn btn-info btn-sm" href="javascript:;">按钮样式</a>
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="gauge" style="height: 300px;"></div>

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">思维导图</div>
                                <div>
                                    <a class="btn btn-info btn-sm" href="javascript:;">按钮样式</a>
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="my_mind_map" style="height: 300px;"></div>

                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">主要污染物饼状图</div>
                                <div>
                                    <a class="btn btn-info btn-sm" href="javascript:;">按钮样式</a>
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="bar" style="height: 300px;"></div>

                            </div>
                        </div>
                    </div>

                </div>



                <!-- 一行 -->
                <div class="row" style="height: 1000px;">
                    <!-- col-lg-4 中的4 大概可以代表宽度 -->
                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">日历图</div>
                                <div>
                                    <a class="btn btn-info btn-sm" href="javascript:;">按钮样式</a>
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="calendar" style="height: 500px;"></div>

                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="ibox">
                            <div class="ibox-head">
                                <div class="ibox-title">气泡轨迹图</div>
                                <div>
                                    <a class="btn btn-info btn-sm" href="javascript:;">按钮样式</a>
                                </div>
                            </div>
                            <div class="ibox-body">
                                <div id="bubbleTrack" style="height: 500px;"></div>

                            </div>
                        </div>
                    </div>

                </div>






            </div>
        </div>
</body>

<script>
    //全局变量定义处！！！！！！！！！！
    var marker_all = [];
    var map;
    var extract_data;
    var columns;
    var month_data = []; //一个月的数据
    var year = 2013; //默认年份
    var bubbleTrack;
    //！！！！！！！！！！！！！！！！！


    async function run() {
        bubbleTrack = await drawBubbleTrack()
        await drawMap()
        onWindowLoad()
        data = Object.values(bubbleTrack.origin_data).map(d => d[0])
        bubbleTrack.cal_month_IAQIs(bubbleTrack.days)
        change_calenda(Object.values(bubbleTrack.IAQIs));
    }
    run()
    //初始加载界面
    function onWindowLoad() {
        var csv_path;
        //初始化
        onload_map();

        //初始化地图
        function onload_map() {
            var choose_day = document.getElementById('slider').value;
            var year = '2013';
            var month = '01';
            var day = '01';
            if (choose_day < 10) {
                day = '0' + String(choose_day);
            } else {
                day = String(choose_day);
            }
            // console.log(day)
            csv_path = "./Material/" + year + month + "/CN-Reanalysis-daily-" + year + month + day + "00.csv"
            add_circle(csv_path);
            //用第一个数据初始化仪表盘  
            Promise.all([
                d3.csv(csv_path, d => {
                    return d
                })
            ]).then((origin_data) => {
                extract_data = d3.filter(origin_data[0], (d, i) => {
                    if (return_IAQI(d) > 151) {
                        return d;
                    }
                })
                change_radar(extract_data[0], columns);
                change_gauge(return_IAQI(extract_data[0]));
                // change_rising_sun();
                change_bar(extract_data[0], columns);
                change_mind_map(extract_data[0], columns);
                // console.log(extract_data)
            });
        }

        //读取一个月数据
        // read_month_data(2013, 1);
    }

    async function drawBubbleTrack() {
        var bubbleTrack = {}
        var years = ['2013', '2014', '2015', '2016', '2017', '2018']
        var months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12']
        bubbleTrack.days = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30']
        var pollution_sources = ['PM2.5', 'PM10', 'SO2', 'NO2', 'CO', 'O3']

        var range = {
            'PM2.5': [0, 35, 75, 115, 150, 250, 350, 500],
            'PM10': [0, 50, 150, 250, 350, 420, 500, 600],
            'SO2': [0, 50, 150, 475, 800, 1600, 2100, 2620],
            'NO2': [0, 40, 80, 180, 280, 565, 750, 940],
            'CO': [0, 2, 4, 14, 24, 36, 48, 60],
            'O3': [0, 160, 200, 300, 400, 800, 1000, 1200],
            'IAQI': [0, 50, 100, 150, 200, 300, 400, 500]
        }

        bubbleTrack.location = [18.34, 109.25]
        bubbleTrack.year = '2013'
        bubbleTrack.target_x = 'PM2.5'
        bubbleTrack.target_y = 'PM2.5'
        bubbleTrack.IAQIs = {};
        var IAQI = function (arg_data, keyword) {
            //figure out index
            var value = arg_data[keyword]
            var index = 0
            while (value > range[keyword][index]) {
                index++
            }
            //at this time the section is [index - 1, index]

            //define scale
            var scale = d3.scaleLinear()
                .domain([range[keyword][index - 1], range[keyword][index]])
                .range([range['IAQI'][index - 1], range['IAQI'][index]])
            return Math.round(scale(value))
        }

        function cal_daily_IAQIs(day, arg_data) {
            var pollution_sources = ['PM2.5', 'PM10', 'SO2', 'NO2', 'CO', 'O3']
            bubbleTrack.IAQIs[day] = {}
            pollution_sources.map(d => {
                bubbleTrack.IAQIs[day][d] = IAQI(arg_data, d)
            })
        }

        bubbleTrack.cal_month_IAQIs = function (days) {
            console.log(bubbleTrack.origin_data)
            console.log(days)
            days.map(day => {
                cal_daily_IAQIs(day, bubbleTrack.origin_data[day][0])
            })
        }
        addDropDown()
        function addDropDown() {
            var dom = document.getElementById("bubbleTrack")
            var width = dom.offsetWidth
            var height = dom.offsetHeight
            var margin = { left: width * 0.1, right: width * 0.05, top: height * 0.05, bottom: height * 0.15 }

            d3.select("#bubbleTrack").append("select")
                .on("change", function () {
                    var select = document.getElementById("dropdown-X")
                    var index = select.selectedIndex
                    var value = select.options[index].value
                    bubbleTrack.target_x = value
                    bubbleTrack.Update(bubbleTrack.location, bubbleTrack.year, bubbleTrack.target_x, bubbleTrack.target_y)
                })
                .attr("transform", `translate(${width * 0.9},${height * 0.9 - margin.bottom})`)
                .attr("id", "dropdown-X")
                .selectAll("option")
                .data(pollution_sources)
                .enter()
                .append("option")
                .text(d => d)

            d3.select("#bubbleTrack").append("select")
                .on("change", function () {

                    var select = document.getElementById("dropdown-Y")
                    var index = select.selectedIndex

                    var value = select.options[index].value
                    bubbleTrack.target_y = value
                    bubbleTrack.Update(bubbleTrack.location, bubbleTrack.year, bubbleTrack.target_x, bubbleTrack.target_y)
                })
                .attr("transform", `translate(${margin.left * 1.2}, ${(height - margin.bottom) / 10})`)
                .attr("id", "dropdown-Y")
                .attr("position", 'absolute')
                .attr("top", "20%")
                .selectAll("option")
                .data(pollution_sources)
                .enter()
                .append("option")
                .text(d => d)

            d3.select("#bubbleTrack").append("select")
                .on("change", function () {

                    var select = document.getElementById("dropdown-Year")
                    var index = select.selectedIndex

                    var value = select.options[index].value
                    bubbleTrack.year = value
                    bubbleTrack.Update(bubbleTrack.location, bubbleTrack.year, bubbleTrack.target_x, bubbleTrack.target_y)
                })
                .attr("transform", `translate(${margin.left * 1.2}, ${(height - margin.bottom) / 10})`)
                .attr("id", "dropdown-Year")
                .attr("position", 'absolute')
                .attr("top", "20%")
                .selectAll("option")
                .data(years)
                .enter()
                .append("option")
                .text(d => d)
        }

        //Air Quality Level
        //arg_data是一条数据项（也就是表格里的一行）

        function AQL(arg_data) {

            var pollution_sources = ['PM2.5', 'PM10', 'SO2', 'NO2', 'CO', 'O3']
            //检查是否有某一项污染物浓度超过最大检测范围
            pollution_sources.forEach(source => {
                if (arg_data[source] >= range[source][7]) {
                    return {
                        level: 6,
                        name: "严重污染"
                    }
                }
            })
            var AQI = d3.max(pollution_sources.map(d => IAQI(arg_data, d)))
            return cal_AQL(AQI)

            function cal_AQL(value) {
                if (value >= 0 && value <= 50) {
                    return {
                        level: 1,
                        name: "优"
                    }
                }
                if (value > 50 && value <= 100) {
                    return {
                        level: 2,
                        name: "良"
                    }
                }
                if (value > 100 && value <= 150) {
                    return {
                        level: 3,
                        name: "轻度污染"
                    }
                }
                if (value > 150 && value <= 200) {
                    return {
                        level: 4,
                        name: "中度污染"
                    }
                }
                if (value > 200 && value <= 300) {
                    return {
                        level: 5,
                        name: "重度污染"
                    }
                }
                if (value > 300) {
                    return {
                        level: 6,
                        name: "严重污染"
                    }
                }
            }

        }

        async function load(location, year) {
            //NOTE:
            // days.forEach(d => {
            //     d3.csv(`Material/${year}${month}/CN-Reanalysis-daily-${year}${month}${d}00.csv`, _data => {
            //         //console.log("")
            //         if (+_data[' lat'] >= 35 && +_data[' lat'] <= 40) {
            //             var to_push = {}
            //             for (let i = 0; i < keys.length; i++) {
            //                 to_push[keys[i]] = +_data[originKeys[i]]
            //             }
            //             bubbleTrack['origin_data'][`${d}`].push(to_push)
            //         }
            //     })
            // })
            // console.log("load")
            //generate Object array in order to store data

            //Renamed keys
            var keys = ['PM2.5', 'PM10', 'SO2', 'NO2', 'CO', 'O3', 'U', 'V', 'TEMP', 'RH', 'PSFC', 'lat', 'lon']
            //Origin keys
            var originKeys = ['PM2.5(微克每立方米)', ' PM10(微克每立方米)', ' SO2(微克每立方米)', ' NO2(微克每立方米)', ' CO(毫克每立方米)', ' O3(微克每立方米)', ' U(m/s)', ' V(m/s)', ' TEMP(K)', ' RH(%)', ' PSFC(Pa)', ' lat', ' lon']
            function generateObject(arr1, arr2) {
                var data = {}
                for (var i = 0; i < arr1.length; i++) {
                    data[`${arr1[i]}`] = arr2[i]
                }
                return data
            }
            bubbleTrack['origin_data'] = generateObject(bubbleTrack.days, bubbleTrack.days.map(d => []))
            return Promise.all(bubbleTrack.days.map(d => d3.csv(`Material/${year}01/CN-Reanalysis-daily-${year}01${d}00.csv`, _data => {
                if (+_data[' lat'] === location[0] && +_data[' lon'] === location[1]) {
                    var to_push = {}
                    for (let i = 0; i < keys.length; i++) {
                        to_push[keys[i]] = +_data[originKeys[i]]
                    }
                    bubbleTrack['origin_data'][`${d}`].push(to_push)
                }
            })))
        }
        await load(bubbleTrack.location, bubbleTrack.year)

        bubbleTrack.createBubbleTrack = function (location, year, target_x, target_y) {
            var dom = document.getElementById("bubbleTrack")
            var width = dom.offsetWidth
            var height = dom.offsetHeight
            var margin = { left: width * 0.1, right: width * 0.05, top: height * 0.05, bottom: height * 0.15 }

            bubbleTrack.svg = d3.select("#bubbleTrack").append("svg")
                .attr("id", "bubbleTrack_svg")
                .attr("width", width)
                .attr("height", height)

            bubbleTrack.data = []
            //construct data object
            for (var i = 0; i < bubbleTrack.days.length; i++) {
                var to_push = {}
                to_push['day'] = i
                console.log(`${bubbleTrack.days[i]}`)
                console.log(bubbleTrack['origin_data'][`${bubbleTrack.days[i]}`])

                to_push['x'] = bubbleTrack['origin_data'][`${bubbleTrack.days[i]}`][0][`${target_x}`]
                to_push['y'] = bubbleTrack['origin_data'][`${bubbleTrack.days[i]}`][0][`${target_y}`]
                bubbleTrack.data.push(to_push)
            }
            console.log(bubbleTrack.data)

            //create scales
            bubbleTrack['xScale'] = d3.scaleLinear()
                .domain([0, d3.max(bubbleTrack.data.map(d => d['x']))])
                // .domain(d3.extent(bubbleTrack.data.map(d => d['x'])))
                .range([margin.left, width - margin.right])

            bubbleTrack['yScale'] = d3.scaleLinear()
                .domain([0, d3.max(bubbleTrack.data.map(d => d['y']))])
                // .domain(d3.extent(bubbleTrack.data.map(d => d['y'])))
                .range([height - margin.bottom, margin.top])

            // bubbleTrack.rScale = d3.scaleLinear()
            //     .domain(d3.extent(bubbleTrack.data.map(d => d['day'])))
            //     .range([1, 20])

            bubbleTrack.colorScale = d3.scaleLinear()
                // .domain([d3.min(bubbleTrack.data.map(d => d['day'])),d3.max(bubbleTrack.data.map(d => d['day'])) / 2, d3.max(bubbleTrack.data.map(d => d['day']))])
                // .range(["red", "green","black"])
                .domain(d3.extent(bubbleTrack.data.map(d => d['day'])))
                .range(["red", "black"])

            //add axis
            bubbleTrack.svg.append("g").call(d3.axisBottom(bubbleTrack['xScale'])).attr("transform", `translate(0,${height - margin.bottom})`)
            bubbleTrack.svg.append("g").call(d3.axisLeft(bubbleTrack['yScale'])).attr("transform", `translate(${margin.left},0)`)


            //create label
            bubbleTrack.xlabel = bubbleTrack.svg.append("text")
                .attr("transform", `translate(${width * 0.9},${height * 0.9 - margin.bottom})`)
                .attr("id", "x-label")
                .text(`${target_x}`)

            bubbleTrack.xlabel = bubbleTrack.svg.append("text")
                .attr("transform", `translate(${margin.left * 1.2}, ${(height - margin.bottom) / 10})`)
                .attr("id", "y-label")
                .text(`${target_y}`)

            //create circles
            bubbleTrack.circles = bubbleTrack.svg.append("g").selectAll("circle").data(bubbleTrack.data)
                .join("circle")
                .attr("cx", d => bubbleTrack.xScale(d['x']))
                .attr("cy", d => bubbleTrack.yScale(d['y']))
                .attr("r", 10)
                .attr("fill", d => bubbleTrack.colorScale(d['day']))
                .attr("stroke", "black")
                .attr("stroke-width", 1)
                .attr("opacity", 0.7)

            bubbleTrack.circles.append("title")
                .text(d => `${d['day']}`)

            //create lines
            var curveGenerator = d3.line()
                .x(function (d) { return bubbleTrack.xScale(d['x']) })
                .y(function (d) { return bubbleTrack.yScale(d['y']) })

            bubbleTrack.line = bubbleTrack.svg.append("path").datum(bubbleTrack['origin_data'])
                .attr("fill", "none")
                .attr("stroke", "gray")
                .attr("stroke-width", 1)
                .attr("d", curveGenerator(bubbleTrack.data))
                .attr("opacity", 0.05)
        }

        bubbleTrack.Update = async function (location, year, target_x, target_y) {
            await load(location, year)
            d3.select("#bubbleTrack_svg").remove()
            bubbleTrack.createBubbleTrack(location, year, target_x, target_y)
        }

        bubbleTrack.updateChart = async function (e) {
            console.log(e)
            bubbleTrack.location = [e.latlng['lat'], e.latlng['lng']]
            await bubbleTrack.Update(bubbleTrack.location, bubbleTrack.year, bubbleTrack.target_x, bubbleTrack.target_y)
        }

        var locations = bubbleTrack['origin_data']['01'].map(d => [d['lat'], d['lon']])
        bubbleTrack.createBubbleTrack(bubbleTrack.location, bubbleTrack.year, bubbleTrack.target_x, bubbleTrack.target_y)
        //bubbleTrack.updateChart(locations[100])
        //return bubbleTrack
        //console.log(bubbleTrack)

        return bubbleTrack

    }

    //读取一个月的数据
    function read_month_data(year, month) {
        // console.log(123)
        var month_day = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        if (year % 100 != 0 && year % 4 == 0 || year % 400 == 0) {
            month_day[1] = 29
        }
        year = String(year);
        days = month_day[month - 1];
        if (month < 10) {
            month = '0' + String(month);
        } else {
            month = String(month);
        }
        // console.log(days)
        for (var day = 1; day <= days; day++) {
            // console.log(day)
            if (day < 10) {
                day = '0' + String(day);
            } else {
                day = String(day);
            }
            csv_path = "./Material/" + year + month + "/CN-Reanalysis-daily-" + year + month + day + "00.csv";
            Promise.all([
                d3.csv(csv_path, d => {
                    return d
                })
            ]).then((origin_data) => {
                // console.log(origin_data)
                month_data.push(origin_data);
                // console.log(month_data);
            });
        }

    }
    //滑块事件
    function slider_change() {
        var my_slider = document.getElementById('slider');
        var my_text = document.getElementById('active-day');
        // console.log(my_slider.value);
        my_text.innerHTML = my_slider.value;
        var year = '2013';
        var month = '01';
        var day = '01';
        if (my_slider.value < 10) {
            day = '0' + String(my_slider.value);
        } else {
            day = String(my_slider.value);
        }
        // console.log(day)
        var csv_path = "./Material/" + year + month + "/CN-Reanalysis-daily-" + year + month + day + "00.csv"
        add_circle(csv_path);
    }
    //画地图    
    async function drawMap() {
        //console.log(arg_bubbleTrack)
        var mapEntry = {}

        //mapbox的token
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2hpenVndWlsYWkiLCJhIjoiY2twaG11Mmw3MDR4MzJ3bjdmNjMxOHFuciJ9.w_6qQyQKApZhcqzXExlL0A';
        //设置拖拽范围
        var corner1 = L.latLng(54.7, 72.5); //设置左上角经纬度
        var corner2 = L.latLng(17.1, 136);	//设置右下点经纬度
        var bounds = L.latLngBounds(corner1, corner2); //构建视图限制范围

        //编辑地图
        map = L.map('map', {
            center: [40.148, 84.9023],
            zoom: 3,
            maxZoom: 10,
            minZoom: 3,
            maxBounds: bounds,
        })
        //确定选点比例, 1/x
        // extract = 50;

        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + mapboxgl.accessToken, {
            id: 'mapbox/light-v9',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);
    }
    //一个返回IAQI指数的函数
    function return_IAQI(data) {
        var IAQI = 0;
        if ((data['PM2.5(微克每立方米)'] >= 35 && data['PM2.5(微克每立方米)'] < 75) ||
            (data['PM10(微克每立方米)'] >= 50 && data['PM10(微克每立方米)'] < 150) ||
            (data['SO2(微克每立方米)'] >= 150 && data['SO2(微克每立方米)'] < 500) ||
            (data['CO(毫克每立方米)'] >= 5 && data['CO(毫克每立方米)'] < 10) ||
            (data['NO2(微克每立方米)'] >= 100 && data['NO2(微克每立方米)'] < 200)) {
            IAQI = IAQI < 50 ? 50 : IAQI;
        }
        else if ((data['PM2.5(微克每立方米)'] >= 75 && data['PM2.5(微克每立方米)'] < 115) ||
            (data['PM10(微克每立方米)'] >= 150 && data['PM10(微克每立方米)'] < 250) ||
            (data['SO2(微克每立方米)'] >= 500 && data['SO2(微克每立方米)'] < 650) ||
            (data['CO(毫克每立方米)'] >= 10 && data['CO(毫克每立方米)'] < 35) ||
            (data['NO2(微克每立方米)'] >= 200 && data['NO2(微克每立方米)'] < 700)) {
            IAQI = IAQI < 100 ? 100 : IAQI;
        }
        else if ((data['PM2.5(微克每立方米)'] >= 115 && data['PM2.5(微克每立方米)'] < 150) ||
            (data['PM10(微克每立方米)'] >= 250 && data['PM10(微克每立方米)'] < 350) ||
            (data['SO2(微克每立方米)'] >= 650 && data['SO2(微克每立方米)'] < 800) ||
            (data['CO(毫克每立方米)'] >= 35 && data['CO(毫克每立方米)'] < 60) ||
            (data['NO2(微克每立方米)'] >= 700 && data['NO2(微克每立方米)'] < 1200)) {
            IAQI = IAQI < 150 ? 150 : IAQI;
        }
        else if ((data['PM2.5(微克每立方米)'] >= 150 && data['PM2.5(微克每立方米)'] < 250) ||
            (data['PM10(微克每立方米)'] >= 350 && data['PM10(微克每立方米)'] < 420) ||
            (data['CO(毫克每立方米)'] >= 60 && data['CO(毫克每立方米)'] < 90) ||
            (data['NO2(微克每立方米)'] >= 1200 && data['NO2(微克每立方米)'] < 2340)) {
            IAQI = IAQI < 200 ? 200 : IAQI;
        }
        else if ((data['PM2.5(微克每立方米)'] >= 250 && data['PM2.5(微克每立方米)'] < 350) ||
            (data['PM10(微克每立方米)'] >= 420 && data['PM10(微克每立方米)'] < 500) ||
            (data['CO(毫克每立方米)'] >= 90 && data['CO(毫克每立方米)'] < 120) ||
            (data['NO2(微克每立方米)'] >= 2340 && data['NO2(微克每立方米)'] < 3090)) {
            IAQI = IAQI < 300 ? 300 : IAQI;
        }
        else if ((data['PM2.5(微克每立方米)'] >= 350 && data['PM2.5(微克每立方米)'] < 500) ||
            (data['PM10(微克每立方米)'] >= 500 && data['PM10(微克每立方米)'] < 600) ||
            (data['CO(毫克每立方米)'] >= 120 && data['CO(毫克每立方米)'] < 150) ||
            (data['NO2(微克每立方米)'] >= 3090 && data['NO2(微克每立方米)'] < 3840)) {
            IAQI = IAQI < 400 ? 400 : IAQI;
        }
        else if (data['PM2.5(微克每立方米)'] >= 500 ||
            data['PM10(微克每立方米)'] >= 600 ||
            data['CO(毫克每立方米)'] >= 150 ||
            data['NO2(微克每立方米)'] >= 3840) {
            IAQI = IAQI < 500 ? 500 : IAQI;
        }
        return IAQI;
    }
    //添加圈圈
    function add_circle(csv_path) {
        // console.log(csv_path)
        Promise.all([
            d3.csv(csv_path, d => {
                return d
            })
        ]).then((origin_data) => {
            // console.log(origin_data)
            // console.log(origin_data[0][0])
            var columns = origin_data[0].columns;
            // console.log(origin_data[0])
            // console.log(columns)
            draw_circle(origin_data);
            //散点圈函数（根据数据画圈）
            function draw_circle(data) {
                //抽取
                extract_data = d3.filter(origin_data[0], (d, i) => {
                    if (return_IAQI(d) > 151) {
                        return d;
                    }
                })
                // console.log(extract_data)
                //定义一个颜色比例尺
                var color_scale = d3.scaleLinear()
                    .domain([0, 200, 300, 400, 500])
                    // .range(["#2fff00", "#ffee00", "#ff0000", "#a30399", "rgb(143, 1, 110)"]);
                    .range(["#33ff57", "#75ff33", "#dbff33", "#ffbd33", "#ff5733"]);
                // .range(["33ffbd", "#ffbd33", "#ff5733"])
                //绿色、黄色、橙色、红色、紫色、红褐色
                //删除之前的球
                var myGroup = L.layerGroup(marker_all);
                map.addLayer(myGroup);
                myGroup.clearLayers();
                for (var i = 0; i < extract_data.length; i++) {
                    var latlng = [extract_data[i][' lat'], extract_data[i][' lon']];
                    // console.log(extract_data[i]['PM2.5(微克每立方米)'])
                    // console.log(origin_data[0][0])
                    // console.log(return_IAQI(extract_data[i]))
                    marker = L.circle(latlng, {
                        radius: return_IAQI(extract_data[i]) * 20,
                        weight: 1,
                        color: color_scale(return_IAQI(extract_data[i])), //这是边框的颜色
                        fillColor: color_scale(return_IAQI(extract_data[i])),
                        fillOpacity: 0.3,
                        // data: extract_data[i]
                        // popupopen: print(),
                    }).on('click', click_event).addTo(map)
                    marker_all.push(marker);
                }

            }


        });
    }
    //点击圈事件
    async function click_event(e) {
        var latLng = e.latlng;
        var cur_latlng = [latLng.lat, latLng.lng]
        for (var i = 0; i < extract_data.length; i++) {
            var latlng = [extract_data[i][' lat'], extract_data[i][' lon']];
            if (Math.abs(cur_latlng[0] - latlng[0]) < 1e-1 && Math.abs(cur_latlng[1] - latlng[1]) < 1e-1) {
                change_radar(extract_data[i], columns);
                change_gauge(return_IAQI(extract_data[i]));
                change_bar(extract_data[i], columns);
                change_mind_map(extract_data[i], columns)
                await bubbleTrack.updateChart(e)
                bubbleTrack.cal_month_IAQIs(bubbleTrack.days)
                change_calenda(Object.values(bubbleTrack.IAQIs));
                break;
            }
        }
    }
    //雷达图函数
    function change_radar(data, columns) {
        // console.log(data)
        var chartDom = document.getElementById('radar');
        var myChart = echarts.init(chartDom);
        var option;
        var keys = Object.keys(data);
        // console.log(keys)
        var final_data = [];
        for (var i = 0; i < 6; i++) {
            final_data.push(Number(data[keys[i]]));
        }
        // console.log(final_data)

        option = {
            color: ['#FFE434'],
            legend: {
                data: ["主要污染物"]
            },
            tooltip: {
                trigger: 'item'
            },

            radar: {
                // shape: 'circle',
                indicator: [
                    { name: keys[0], max: 560 },
                    { name: keys[1], max: 750 },
                    { name: keys[2], max: 800 },
                    { name: keys[3], max: 940 },
                    { name: keys[4], max: 150 },
                    { name: keys[5], max: 900 },
                ],
                name: {
                    textStyle: {
                        color: '#fff',
                        backgroundColor: '#666',
                        borderRadius: 3,
                        padding: [3, 5]
                    }
                },
                splitArea: {
                    areaStyle: {
                        color: ['#77EADF', '#26C3BE', '#64AFE9', '#428BD4'],
                        shadowColor: 'rgba(0, 0, 0, 0.2)',
                        shadowBlur: 10
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: 'rgba(211, 253, 250, 0.8)'
                    }
                },
                splitLine: {
                    lineStyle: {
                        color: 'rgba(211, 253, 250, 0.8)'
                    }
                }
            },
            series: [{
                name: '主要污染源占比',
                type: 'radar',
                data: [
                    {
                        value: final_data,
                        name: '主要污染源占比',
                        lineStyle: {
                            type: 'dashed'
                        },

                    },

                ]
            }]
        };

        option && myChart.setOption(option);

    }
    //仪表盘函数
    function change_gauge(IAQI) {
        var chartDom = document.getElementById('gauge');
        var myChart = echarts.init(chartDom);
        var option;

        option = {
            series: [{
                type: 'gauge',
                startAngle: 180,
                endAngle: 0,
                min: 500,
                max: 0,
                splitNumber: 10,
                axisLine: {
                    lineStyle: {
                        width: 6,
                        color: [
                            [0.25, '#FF6E76'],
                            [0.5, '#FDDD60'],
                            [0.75, '#58D9F9'],
                            [1, '#7CFFB2']
                        ]
                    }
                },
                pointer: {
                    icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',
                    length: '12%',
                    width: 20,
                    offsetCenter: [0, '-60%'],
                    itemStyle: {
                        color: 'auto'
                    }
                },
                axisTick: {
                    length: 12,
                    lineStyle: {
                        color: 'auto',
                        width: 2
                    }
                },
                splitLine: {
                    length: 20,
                    lineStyle: {
                        color: 'auto',
                        width: 5
                    }
                },
                axisLabel: {
                    color: '#464646',
                    fontSize: 20,
                    distance: -60,
                    formatter: function (value) {
                        if (value === 50) {
                            return '优';
                        }
                        else if (value === 200) {
                            return '中';
                        }
                        else if (value === 300) {
                            return '良';
                        }
                        else if (value === 450) {
                            return '差';
                        }
                    }
                },
                title: {
                    offsetCenter: [0, '-20%'],
                    fontSize: 25
                },
                detail: {
                    fontSize: 20,
                    offsetCenter: [0, '0%'],
                    valueAnimation: true,
                    formatter: function (value) {
                        if (value <= 50) {
                            return '优';
                        }
                        else if (value <= 200) {
                            return '中';
                        }
                        else if (value <= 300) {
                            return '良';
                        }
                        else {
                            return '差';
                        }
                        return Math.round(value);
                    },
                    color: 'auto'
                },
                data: [{
                    value: IAQI,
                    // fontSize: 30,
                    name: 'IAQI评定'
                }]
            }]
        };

        option && myChart.setOption(option);

    }
    //旭日图函数
    function change_rising_sun() {
        var chartDom = document.getElementById('rising_sun');
        var myChart = echarts.init(chartDom);
        var option;

        var data = [
            [5000, 10000, 6785.71],
            [4000, 10000, 6825],
            [3000, 6500, 4463.33],
            [2500, 5600, 3793.83],
            [2000, 4000, 3060],
            [2000, 4000, 3222.33],
            [2500, 4000, 3133.33],
            [1800, 4000, 3100],
            [2000, 3500, 2750],
            [2000, 3000, 2500],
            [1800, 3000, 2433.33],
            [2000, 2700, 2375],
            [1500, 2800, 2150],
            [1500, 2300, 2100],
            [1600, 3500, 2057.14],
            [1500, 2600, 2037.5],
            [1500, 2417.54, 1905.85],
            [1500, 2000, 1775],
            [1500, 1800, 1650]
        ];

        //定义每个柱状体的坐标和高度和阈值，上网查污染物指标只有六个 应该留下六个就可以 可以考虑加入温度和湿度，风力等因素，这样表示的东西会更复杂一些

        var cities = ['二氧化碳', '二氧化氮', '二氧化硫', '臭氧', '悬浮颗粒物', '细颗粒物'];
        var barHeight = 50;

        option = {
            title: {
                text: '地区空气污染情况',
                subtext: '各个污染物含量及指标对比'
            },
            legend: {
                show: true,
                data: ['污染浓度范围', '污染浓度参考值']
            },
            grid: {
                top: 100
            },
            angleAxis: {
                type: 'category',
                data: cities
            },
            tooltip: {
                show: true,
                formatter: function (params) {
                    var id = params.dataIndex;
                    return cities[id] + '<br>最低：' + data[id][0] + '<br>最高：' + data[id][1] + '<br>平均：' + data[id][2];
                }
            },                                                //鼠标悬停时显示最大最小值
            radiusAxis: {
            },
            polar: {
            },
            series: [{
                type: 'bar',
                itemStyle: {
                    color: 'transparent'
                },
                data: data.map(function (d) {
                    return d[0];
                }),
                coordinateSystem: 'polar',
                stack: '最大最小值',
                silent: true
            }, {
                type: 'bar',
                data: data.map(function (d) {
                    return d[1] - d[0];
                }),
                coordinateSystem: 'polar',
                name: '浓度范围',
                stack: '最大最小值'
            }, {
                type: 'bar',
                itemStyle: {
                    color: 'transparent'
                },                                                   //定义bar的颜色，和浓度的最大最小值
                data: data.map(function (d) {
                    return d[2] - barHeight;
                }),
                coordinateSystem: 'polar',
                stack: '均值',
                silent: true,
                z: 10
            }, {
                type: 'bar',
                data: data.map(function (d) {
                    return barHeight * 2;
                }),
                coordinateSystem: 'polar',
                name: '均值',
                stack: '均值',
                barGap: '-100%',
                z: 10
            }]
        };                                          //均值按钮变化过程

        option && myChart.setOption(option);

    }
    //饼状图函数
    function change_bar(data, columns) {
        var chartDom = document.getElementById('bar');
        var myChart = echarts.init(chartDom);
        var option;
        // console.log(columns)
        var keys = Object.keys(data);
        // console.log(keys)
        var final_data = [];
        for (var i = 0; i < 6; i++) {
            final_data.push(Number(data[keys[i]]));
        }
        option = {
            title: {
                // text: '某站点用户访问来源',
                // subtext: '纯属虚构',
                left: 'center'
            },
            center: ['60%', '40%'],
            tooltip: {
                trigger: 'item'
            },
            legend: {
                orient: 'vertical',
                left: 'left',
            },
            series: [
                {
                    name: '数据项：',
                    type: 'pie',
                    radius: '50%',
                    data: [
                        { value: final_data[0], name: keys[0] },
                        { value: final_data[1], name: keys[1] },
                        { value: final_data[2], name: keys[2] },
                        { value: final_data[3], name: keys[3] },
                        { value: final_data[4], name: keys[4] },
                        { value: final_data[5], name: keys[5] },
                        // { value: final_data[6], name: keys[6] }
                    ],
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };

        option && myChart.setOption(option);

    }
    //思维导图函数
    function change_mind_map(data, columns) {
        var drawMindMapEntry = {};
        margin = ({ top: 50, right: 120, bottom: 10, left: 0 });
        var width = 960;
        //思维导图的宽和高
        dx = 50;
        dy = width / 8;
        var dataset;
        console.log(data)
        var keys = Object.keys(data)
        // console.log(keys)
        var dataset = {};
        dataset.name = "污染成分思维导图";
        dataset.children = [];
        for (var i = 0; i < 6; i++) {
            var temp = { name: keys[i] + String(data[keys[i]]), value: data[keys[i]] }
            dataset.children.push(temp);
        }
        console.log(dataset)
        data = dataset;
        console.log(data)

        const root = d3.hierarchy(data);
        tree = d3.tree().nodeSize([dx, dy]);
        diagonal = d3.linkHorizontal().x(d => d.y).y(d => d.x);
        root.x0 = dy / 2;
        root.y0 = 0;
        root.descendants().forEach((d, i) => {
            d.id = i;
            d._children = d.children;
            if (d.depth && d.data.name.length !== 7) d.children = null;
        });
        //删除之前的    
        d3.select("#mind_map").remove()

        const svg = d3.select("#my_mind_map")
            .append("svg")
            .attr("id", "mind_map")

            .attr("transform", "translate(0,5)")
            .attr("viewBox", [-(margin.left + 150), -margin.top, width / 2, dx])
            .style("font", "15px sans-serif")
            .style("user-select", "none");

        const gLink = svg.append("g")
            .attr("fill", "none")
            .attr("stroke", "#555")
            .attr("stroke-opacity", 0.35)
            .attr("stroke-width", 1.5);

        const gNode = svg.append("g")
            .attr("cursor", "pointer")
            .attr("pointer-events", "all");

        function update(source) {
            const duration = d3.event && d3.event.altKey ? 2500 : 250;
            const nodes = root.descendants().reverse();
            const links = root.links();

            // Compute the new tree layout.
            tree(root);

            let left = root;
            let right = root;
            root.eachBefore(node => {
                if (node.x < left.x) left = node;
                if (node.x > right.x) right = node;
            });

            const height = right.x - left.x + margin.top + margin.bottom;

            const transition = svg.transition()
                .duration(duration)
                .attr("viewBox", [-(margin.left + 150), left.x - margin.top, width / 2, height])
                .tween("resize", window.ResizeObserver ? null : () => () => svg.dispatch("toggle"));

            // Update the nodes…
            const node = gNode.selectAll("g")
                .data(nodes, d => d.id);

            // Enter any new nodes at the parent's previous position.
            const nodeEnter = node.enter().append("g")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .attr("fill-opacity", 0)
                .attr("stroke-opacity", 0)
                .on("click", (event, d) => {
                    d.children = d.children ? null : d._children;
                    update(d);
                });

            nodeEnter.append("circle")
                .attr("r", 2.5)
                .attr("fill", d => d._children ? "#555" : "#999")
                .attr("stroke-width", 10);

            nodeEnter.append("text")
                .attr("dy", "0.31em")
                .attr("x", d => d._children ? -6 : 6)
                .attr("text-anchor", d => d._children ? "end" : "start")
                .text(d => d.data.name)
                .clone(true).lower()
                .attr("stroke-linejoin", "round")
                .attr("stroke-width", 3)
                .attr("stroke", "white");

            // Transition nodes to their new position.
            const nodeUpdate = node.merge(nodeEnter).transition(transition)
                .attr("transform", d => `translate(${d.y},${d.x})`)
                .attr("fill-opacity", 1)
                .attr("stroke-opacity", 1);

            // Transition exiting nodes to the parent's new position.
            const nodeExit = node.exit().transition(transition).remove()
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .attr("fill-opacity", 0)
                .attr("stroke-opacity", 0);

            // Update the links…
            const link = gLink.selectAll("path")
                .data(links, d => d.target.id);

            // Enter any new links at the parent's previous position.
            const linkEnter = link.enter().append("path")
                .attr("d", d => {
                    const o = { x: source.x0, y: source.y0 };
                    return diagonal({ source: o, target: o });
                });

            // Transition links to their new position.
            link.merge(linkEnter).transition(transition)
                .attr("d", diagonal);

            // Transition exiting nodes to the parent's new position.
            link.exit().transition(transition).remove()
                .attr("d", d => {
                    const o = { x: source.x, y: source.y };
                    return diagonal({ source: o, target: o });
                });

            // Stash the old positions for transition.
            root.eachBefore(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        update(root);
    }
    //日历函数
    function change_calenda(data) {
        //console.log(data)
        var app = {};
        var chartDom = document.getElementById('calendar');
        var myChart = echarts.init(chartDom);
        var option;

        var cellSize = [80, 80];
        var pieRadius = 30;

        function getVirtulData() {
            var date = +echarts.number.parseDate('2013-01-01');
            var end = +echarts.number.parseDate('2013-02-01');
            var dayTime = 3600 * 24 * 1000;
            var data = [];
            for (var time = date; time < end; time += dayTime) {
                data.push([
                    echarts.format.formatTime('yyyy-MM-dd', time),
                    Math.floor(Math.random() * 10000)
                ]);
            }
            console.log(data)
            return data;
        }

        function getPieSeries(scatterData, chart, auxiliaryData) {
            console.log(scatterData)
            return scatterData.map(function (item, index) {
                var center = chart.convertToPixel('calendar', auxiliaryData[index]);
                return {
                    id: index + 'pie',
                    type: 'pie',
                    center: center,
                    label: {
                        normal: {
                            formatter: '{c}',
                            position: 'inside'
                        }
                    },
                    radius: pieRadius,
                    data: [
                        { name: 'PM2.5', value: item['PM2.5'] },
                        { name: 'PM10', value: item['PM10'] },
                        { name: 'SO2', value: item['SO2'] },
                        { name: 'CO', value: item['CO'] },
                        { name: 'O3', value: item['O3'] },
                        { name: 'NO2', value: item['NO2'] }
                    ]
                };
            });
        }

        function getPieSeriesUpdate(scatterData, chart, auxiliaryData) {
            return scatterData.map(function (item, index) {
                var center = chart.convertToPixel('calendar', auxiliaryData[index]);
                return {
                    id: index + 'pie',
                    center: center
                };
            });
        }

        var auxiliaryData = getVirtulData()
        var scatterData = data;

        option = {
            tooltip: {},
            legend: {
                data: ['PM2.5', 'PM10', 'SO2', 'CO', 'O3', 'NO2'],
                bottom: 20
            },
            calendar: {
                top: 'middle',
                left: 'center',
                orient: 'vertical',
                cellSize: cellSize,
                yearLabel: {
                    show: false,
                    fontSize: 30
                },
                dayLabel: {
                    margin: 20,
                    firstDay: 1,
                    nameMap: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六']
                },
                monthLabel: {
                    show: false
                },
                range: ['2013-01']
            },
            series: [{
                id: 'label',
                type: 'scatter',
                coordinateSystem: 'calendar',
                symbolSize: 1,
                label: {
                    show: true,
                    formatter: function (params) {
                        return echarts.format.formatTime('dd', params.value[0]);
                    },
                    offset: [-cellSize[0] / 2 + 10, -cellSize[1] / 2 + 10],
                    fontSize: 14
                },
                data: scatterData
            }]
        };

        var pieInitialized;
        setTimeout(function () {
            pieInitialized = true;
            myChart.setOption({
                series: getPieSeries(scatterData, myChart, auxiliaryData)
            });
        }, 10);

        app.onresize = function () {
            if (pieInitialized) {
                myChart.setOption({
                    series: getPieSeriesUpdate(scatterData, myChart, auxiliaryData)
                });
            }
        };

        option && myChart.setOption(option);

    }

</script>